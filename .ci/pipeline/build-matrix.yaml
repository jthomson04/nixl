---
job: nixl-ci-build

# Fail job if one of the steps fails or continue
failFast: false

timeout_minutes: 240

kubernetes:
  cloud: il-ipp-blossom-prod
  namespace: swx-media
  limits: "{memory: 8Gi, cpu: 8000m}"
  requests: "{memory: 8Gi, cpu: 8000m}"

runs_on_dockers:
  - {
      arch: x86_64,
      name: "pytorch-25.02-py3",
      url: "nvcr.io/nvidia/pytorch:25.02-py3",
    }
  - {
      arch: x86_64,
      name: "pytorch-24.10-py3",
      url: "nvcr.io/nvidia/pytorch:24.10-py3",
    }
  - {
      arch: x86_64,
      name: "podman-v5.0.2",
      url: "quay.io/podman/stable:v5.0.2",
      category: 'docker',
      privileged: true, # need for building image in container using podman
    }

pipeline_start:
  shell: action
  module: groovy
  run: |
    import ipp.blossom.*

    withCredentials([usernamePassword(credentialsId: 'github-token', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
      // create new instance of helper object
      githubHelper = GithubHelper.getInstance("${GIT_PASSWORD}", githubData)
      currentBuild.description = githubHelper.getBuildDescription()
    }

pipeline_stop:
    shell: action
    module: groovy
    run: |
      githubHelper.uploadLogs(this, env.JOB_NAME, env.BUILD_NUMBER, null, null)

env:
  NIXL_INSTALL_DIR: /opt/nixl

steps:
  - name: Build
    parallel: false
    run: |
      if [[ "${name}" == "pytorch-24.10-py3" ]]; then
        # distro's meson version is too old project requires >= 0.64.0
        pip3 install meson
      fi
      .gitlab/build.sh ${NIXL_INSTALL_DIR}

  - name: Test CPP
    parallel: false
    run: |
      .gitlab/test_cpp.sh ${NIXL_INSTALL_DIR}

  - name: Test Python
    parallel: false
    run: |
      .gitlab/test_python.sh ${NIXL_INSTALL_DIR}

  - name: Build Docker Image
    parallel: false
    containerSelector:
      - "{ category: 'docker' }"
    run: |
      rm -f /etc/containers/storage.conf ; podman system reset -f || true
      ln -sfT $(type -p podman) /usr/bin/docker
      yum install -y git
      contrib/build-container.sh --no-cache
